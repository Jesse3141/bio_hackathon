# UCSC Nanopore HMM Analysis

Analysis code for the manuscripts "Segmentation of Noisy Signals Generated by a Nanopore" and "Analysis of Nanopore Data using Hidden Markov Models" by Jacob Schreiber and Kevin Karplus.

## Quick Start

### Environment Setup

This code requires Python 2.7 due to dependencies on `yahmm` (deprecated HMM library).

```bash
# Create conda environment
conda env create -f environment_py27.yml
conda activate nanopore_py27

# Register Jupyter kernel
python -m ipykernel install --user --name nanopore_py27 --display-name "Python 2.7 (Nanopore)"
```

### Running in Jupyter

Run JupyterLab from any Python 3 environment (e.g., `bio_hack`) and select the **"Python 2.7 (Nanopore)"** kernel:

```bash
conda activate bio_hack  # or any env with jupyterlab
jupyter lab
```

### Basic Usage

```python
# Use pypore_compat for loading data (bypasses broken PyPore.cparsers)
from pypore_compat import File
from yahmm import Model
from epigenetics_patched import analyze_events

# Load pre-trained HMM
with open('untrained_hmm.txt', 'r') as infile:
    model = Model.read(infile)

# Load pre-segmented events
f = File.from_json('Data/14418004-s04.json')
events = [[seg.mean for seg in event.segments] for event in f.events]

# Classify events
data = analyze_events(events, model)
print(data[['C', 'mC', 'hmC', 'Filter Score']])
```

## Files

| File | Description |
|------|-------------|
| `epigenetics.py` | Original HMM model construction and analysis functions |
| `epigenetics_patched.py` | Patched version with fixed imports for modern setup |
| `pypore_compat.py` | Compatibility layer for loading JSON data (bypasses broken cparsers) |
| `environment_py27.yml` | Conda environment specification |
| `untrained_hmm.txt` | Pre-built HMM model (1070 states) |
| `trained_hmm.txt` | Trained HMM model |
| `Data/*.json` | 13 pre-segmented nanopore recordings (12.5 min each) |

## Data Format

JSON files contain pre-segmented events:

```json
{
  "events": [{
    "segments": [{
      "mean": 41.23,
      "std": 0.82,
      "duration": 0.17,
      "start": 0.001,
      "end": 0.172
    }, ...]
  }, ...]
}
```

## Known Issues

- **PyPore.cparsers is broken**: The Cython-compiled parsers have a missing `core` module. Use `pypore_compat.py` instead for loading JSON data.
- **networkx must be <2.0**: yahmm uses the deprecated `.edge` attribute removed in networkx 2.x
- **Cython must be <3.0**: yahmm's Cython code uses Python 2 print statements

## Notebooks

- `PyPore Tutorial.ipynb` - Tutorial on using PyPore library
- `Cytosine Classification.ipynb` - Replication of the paper's analysis

## References

- Original repository: [UCSCNanopore/Data](https://github.com/UCSCNanopore/Data)
- YAHMM library: [jmschrei/yahmm](https://github.com/jmschrei/yahmm) (deprecated, successor is [pomegranate](https://github.com/jmschrei/pomegranate))

---

*Original README content preserved below:*

---

13 data files, recording 12.5 minutes each, had events detected and segmented automatically. These results are stored in the appropriately named JSON files. PyPore can be used to open these files, using the `File.from_json(filename)` class method.

Test Set.csv is the results of running all test set events through the model, and can be loaded up in Python easily using Pandas.

n_fold_accuracies.txt is the output of the 5-fold cross-validation 10 times used in Fig 7.

threshold_scan.txt is the output used in Fig 4, generated by the function threshold_scan. The accuracies use thresholds 0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 0.75, 0.9 respectively.

Contact: Jacob Schreiber (jmschreiber91@gmail.com)
